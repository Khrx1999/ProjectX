<!-- Start: Advanced Defect Trend Analysis -->
<div class="bg-gradient-to-b from-gray-900 to-black rounded-xl border border-gray-800/80 p-8 shadow-xl shadow-black/20 mb-8 backdrop-blur-sm hover:shadow-2xl transition-all duration-500 relative overflow-hidden">
  <!-- Background Effects -->
  <div class="absolute inset-0 pointer-events-none overflow-hidden">
    <div class="absolute top-0 left-0 w-full h-full bg-pattern-grid opacity-5"></div>
    <div class="absolute -top-24 -right-24 w-96 h-96 bg-red-900/20 rounded-full blur-3xl"></div> <!-- Changed color -->
    <div class="absolute -bottom-24 -left-24 w-96 h-96 bg-pink-900/20 rounded-full blur-3xl"></div> <!-- Changed color -->
    <div class="absolute top-1/4 left-1/3 w-12 h-12 bg-red-600/30 rounded-full blur-xl animate-pulse"></div> <!-- Changed color -->
    <div class="absolute bottom-1/3 right-1/4 w-8 h-8 bg-pink-600/30 rounded-full blur-xl animate-pulse" style="animation-delay: 1s;"></div> <!-- Changed color -->
  </div>
  
  <div class="relative z-10">
    <!-- Header Section -->
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 border-b border-gray-700/80 pb-6">
      <div>
        <div class="flex items-center space-x-3">
          <div class="bg-gradient-to-r from-red-600 to-pink-700 p-2.5 rounded-lg shadow-lg shadow-red-500/20 group-hover:shadow-red-500/40 transition duration-300"> <!-- Changed color -->
            <i class="ri-bug-line text-white text-xl"></i> <!-- Changed icon -->
          </div>
          <div>
            <h2 class="text-2xl font-bold text-white tracking-tight group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-red-400 group-hover:to-pink-400 transition-all duration-500">Defect Trend Analysis</h2> <!-- Changed title -->
            <p class="text-sm text-gray-400 mt-1">แนวโน้มการพบและแก้ไขข้อบกพร่อง</p> <!-- Changed description -->
          </div>
        </div>
      </div>
      
      <!-- Filter Controls (Kept similar structure, might need adjustment based on defect data) -->
      <div class="flex flex-col space-y-3 md:space-y-0 md:flex-row md:space-x-3 mt-4 lg:mt-0 w-full lg:w-auto">
        <!-- Date Range Selector (Example, adjust as needed) -->
        <div class="dropdown relative">
          <button class="dropdown-toggle w-full md:w-auto text-sm bg-gray-800/80 hover:bg-gray-700/90 border border-gray-700 text-gray-200 px-4 py-2 rounded-lg transition-colors flex items-center justify-between space-x-1 shadow-sm focus:ring-2 focus:ring-red-500/50 focus:outline-none"> <!-- Changed focus color -->
            <div class="flex items-center">
              <i class="ri-calendar-line mr-2 text-red-400"></i> <!-- Changed icon color -->
              <span>All Time</span> <!-- Default filter example -->
            </div>
            <i class="ri-arrow-down-s-line ml-2"></i>
          </button>
          <div class="dropdown-menu hidden py-2 rounded-lg bg-gray-800/90 backdrop-blur-sm border border-gray-700 w-full md:w-48 shadow-lg z-10 absolute left-0 md:right-0 mt-1">
             <p class="px-4 py-1 text-xs text-gray-400 border-b border-gray-700/50">Select Period</p>
             <a href="#" class="block text-sm py-2.5 px-4 text-gray-300 hover:bg-gray-700/70 hover:text-white transition-colors flex items-center">
               <i class="ri-check-line mr-2 text-red-500"></i>
               <span>All Time</span>
             </a>
             <a href="#" class="block text-sm py-2.5 px-4 text-gray-300 hover:bg-gray-700/70 hover:text-white transition-colors flex items-center">
               <i class="ri-calendar-2-line mr-2 text-gray-500"></i>
               <span>Last 30 Days</span>
             </a>
             <a href="#" class="block text-sm py-2.5 px-4 text-gray-300 hover:bg-gray-700/70 hover:text-white transition-colors flex items-center">
               <i class="ri-calendar-event-line mr-2 text-gray-500"></i>
               <span>This Sprint</span>
             </a>
          </div>
        </div>
        
        <!-- Period Selector (Example, adjust as needed) -->
        <div class="relative">
          <div class="flex flex-wrap gap-1 border border-gray-700 rounded-lg overflow-hidden bg-gray-800/80 p-0.5">
            <button class="period-btn text-xs px-4 py-2 bg-gray-800 text-gray-300 hover:bg-gray-700 hover:text-white font-medium rounded transition-all duration-300" data-grouping="daily">Daily</button>
            <button class="period-btn text-xs px-4 py-2 bg-gradient-to-r from-red-600 to-pink-600 text-white font-medium rounded transition-all duration-300 shadow-lg shadow-red-900/30" data-grouping="weekly">Weekly</button> <!-- Changed color -->
            <button class="period-btn text-xs px-4 py-2 bg-gray-800 text-gray-300 hover:bg-gray-700 hover:text-white font-medium rounded transition-all duration-300" data-grouping="monthly">Monthly</button>
          </div>
        </div>
        
        <!-- Export & Settings -->
        <div class="flex items-center space-x-2">
          <button class="defect-trend-download-btn bg-gray-800/80 hover:bg-gray-700/90 text-gray-300 hover:text-white rounded-lg p-2 transition-colors border border-gray-700 flex items-center justify-center tooltip-trigger focus:ring-2 focus:ring-red-500/50 focus:outline-none relative group" aria-label="Export data"> <!-- Changed class and focus color -->
            <i class="ri-download-2-line text-sm"></i>
            <div class="tooltip-content hidden group-hover:block absolute -top-9 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-800 text-xs text-gray-300 rounded whitespace-nowrap border border-gray-700">
              Export Chart
            </div>
          </button>
           <button class="bg-gray-800/80 hover:bg-gray-700/90 text-gray-300 hover:text-white rounded-lg p-2 transition-colors border border-gray-700 flex items-center justify-center tooltip-trigger focus:ring-2 focus:ring-red-500/50 focus:outline-none relative group" aria-label="Chart settings">
             <i class="ri-settings-4-line text-sm"></i>
             <div class="tooltip-content hidden group-hover:block absolute -top-9 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-800 text-xs text-gray-300 rounded whitespace-nowrap border border-gray-700">
               Chart Settings
             </div>
           </button>
           <button class="bg-gray-800/80 hover:bg-gray-700/90 text-gray-300 hover:text-white rounded-lg p-2 transition-colors border border-gray-700 flex items-center justify-center tooltip-trigger focus:ring-2 focus:ring-red-500/50 focus:outline-none relative group" aria-label="Refresh data">
             <i class="ri-refresh-line text-sm"></i>
             <div class="tooltip-content hidden group-hover:block absolute -top-9 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-800 text-xs text-gray-300 rounded whitespace-nowrap border border-gray-700">
               Refresh Data
             </div>
           </button>
        </div>
      </div>
    </div>

    <!-- KPI Cards for Defects -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Defects -->
      <div class="relative group">
        <div class="absolute -inset-0.5 bg-gradient-to-r from-gray-700/40 to-slate-700/40 rounded-xl blur opacity-30 group-hover:opacity-70 transition duration-500 group-hover:duration-200"></div>
        <div class="relative bg-gray-900/90 backdrop-blur-sm rounded-xl p-5 shadow-xl border border-gray-800/80 hover:border-gray-700/30 transition-all duration-300 h-full overflow-hidden">
          <div class="absolute top-1/4 right-1/4 w-1.5 h-1.5 rounded-full bg-gray-500/30 animate-float"></div>
          <div class="flex items-center mb-2 justify-between">
            <span class="text-sm font-medium text-gray-400">Total Defects</span>
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-600/90 to-slate-600/90 flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg shadow-gray-500/30">
              <i class="ri-file-list-3-line text-white text-xl"></i>
            </div>
          </div>
          <div class="mt-3 flex items-baseline justify-between">
            <div>
              <div class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-400 to-slate-400 count-animation neon-text-gray" data-count="{{TOTAL_DEFECTS}}">0</div>
              <div class="text-xs text-gray-400 mt-1.5">Total recorded</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Open Defects -->
      <div class="relative group">
        <div class="absolute -inset-0.5 bg-gradient-to-r from-red-700/40 to-pink-700/40 rounded-xl blur opacity-30 group-hover:opacity-70 transition duration-500 group-hover:duration-200"></div>
        <div class="relative bg-gray-900/90 backdrop-blur-sm rounded-xl p-5 shadow-xl border border-gray-800/80 hover:border-red-800/30 transition-all duration-300 h-full overflow-hidden">
          <div class="absolute top-1/3 right-1/5 w-1.5 h-1.5 rounded-full bg-red-500/30 animate-float"></div>
          <div class="flex items-center mb-2 justify-between">
            <span class="text-sm font-medium text-gray-400">Open Defects</span>
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-600/90 to-pink-600/90 flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg shadow-red-500/30">
              <i class="ri-folder-open-line text-white text-xl"></i>
            </div>
          </div>
          <div class="mt-3 flex items-baseline justify-between">
            <div>
              <div class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-red-400 to-pink-400 count-animation neon-text-red" data-count="{{TOTAL_DEFECTS_OPEN}}">0</div>
              <div class="text-xs text-gray-400 mt-1.5">Currently open</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Closed Defects -->
      <div class="relative group">
        <div class="absolute -inset-0.5 bg-gradient-to-r from-green-700/40 to-emerald-700/40 rounded-xl blur opacity-30 group-hover:opacity-70 transition duration-500 group-hover:duration-200"></div>
        <div class="relative bg-gray-900/90 backdrop-blur-sm rounded-xl p-5 shadow-xl border border-gray-800/80 hover:border-green-800/30 transition-all duration-300 h-full overflow-hidden">
          <div class="absolute bottom-1/3 left-1/4 w-1 h-1 rounded-full bg-emerald-500/30 animate-float-delayed"></div>
          <div class="flex items-center mb-2 justify-between">
            <span class="text-sm font-medium text-gray-400">Closed Defects</span>
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-600/90 to-emerald-600/90 flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg shadow-green-500/30">
              <i class="ri-checkbox-circle-line text-white text-xl"></i>
            </div>
          </div>
          <div class="mt-3 flex items-baseline justify-between">
            <div>
              <div class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-emerald-400 count-animation neon-text-green" data-count="{{TOTAL_DEFECTS_CLOSED}}">0</div>
              <div class="text-xs text-gray-400 mt-1.5">Total fixed</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Average Resolution Time -->
       <div class="relative group">
         <div class="absolute -inset-0.5 bg-gradient-to-r from-amber-700/40 to-yellow-700/40 rounded-xl blur opacity-30 group-hover:opacity-70 transition duration-500 group-hover:duration-200"></div>
         <div class="relative bg-gray-900/90 backdrop-blur-sm rounded-xl p-5 shadow-xl border border-gray-800/80 hover:border-amber-800/30 transition-all duration-300 h-full overflow-hidden">
           <div class="absolute top-1/2 right-1/3 w-1 h-1 rounded-full bg-amber-500/30 animate-float-slow"></div>
           <div class="flex items-center mb-2 justify-between">
             <span class="text-sm font-medium text-gray-400">Avg Resolution Time</span>
             <div class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-600/90 to-yellow-600/90 flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg shadow-amber-500/30">
               <i class="ri-time-line text-white text-xl"></i>
             </div>
           </div>
           <div class="mt-3 flex items-baseline justify-between">
             <div>
               <div class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-amber-400 to-yellow-400 count-animation neon-text-amber" data-count="{{AVG_FIX_TIME_DAYS}}">0</div>
               <div class="text-xs text-gray-400 mt-1.5">Days (average)</div>
             </div>
           </div>
         </div>
       </div>
    </div>
    
    <!-- Chart Container for Defect Trend -->
    <div class="bg-gray-900 rounded-xl p-6 shadow-2xl border border-gray-800 hover:shadow-2xl transition-all duration-300 mb-4 z-0">
      <div class="flex flex-wrap justify-between items-center mb-4">
        <h3 class="text-base font-semibold text-white flex items-center">
          <i class="ri-line-chart-line text-red-400 mr-2"></i> <!-- Changed color -->
          Daily Defect Trend
        </h3>
        <div class="flex space-x-2 mt-2 sm:mt-0">
          <div class="text-xs font-medium text-gray-400 bg-gray-800 rounded-full px-3 py-1 flex items-center">
            <i class="ri-calendar-check-line mr-1"></i>
            <span class="defect-trend-date-range">{{DEFECT_START_DATE}} - {{DEFECT_END_DATE}}</span> <!-- Use defect specific dates -->
          </div>
          <button class="defect-trend-download-btn bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-full p-1.5 transition-colors"> <!-- Changed class -->
            <i class="ri-download-2-line"></i>
          </button>
        </div>
      </div>
      
      <div class="h-[400px] relative rounded-lg p-2">
        <canvas id="defectTrendChart" class="chart-canvas w-full h-full"></canvas> <!-- Changed ID -->
        <!-- Loading placeholder -->
        <div id="defectChartLoading" class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center"> <!-- Changed ID -->
          <div class="flex flex-col items-center">
            <div class="w-12 h-12 rounded-full border-4 border-red-900 border-t-red-400 animate-spin"></div> <!-- Changed color -->
            <p class="mt-3 text-sm text-gray-400">กำลังโหลดข้อมูล...</p>
          </div>
        </div>
      </div>

      <!-- Chart Legend for Defect Trend -->
      <div class="mt-5 flex flex-wrap justify-center gap-x-4 gap-y-3 bg-gray-800/50 rounded-xl p-3 border border-gray-700 shadow-sm">
        <div class="flex items-center">
          <span class="inline-block w-4 h-4 mr-2 rounded-full bg-[rgb(244,63,94)] ring-2 ring-gray-900 shadow-sm"></span>
          <span class="text-sm font-medium text-gray-300">Defects Opened</span>
          <span class="ml-1 text-xs text-gray-400">(Count)</span>
        </div>
        <div class="flex items-center">
          <span class="inline-block w-4 h-4 mr-2 rounded-full bg-[rgb(16,185,129)] ring-2 ring-gray-900 shadow-sm"></span>
          <span class="text-sm font-medium text-gray-300">Defects Closed</span>
          <span class="ml-1 text-xs text-gray-400">(Count)</span>
        </div>
        <!-- Add more legends if needed -->
      </div>
      
      <!-- Optional: explanation text if needed -->
      <!-- <div class="mt-2 text-xs text-gray-500 text-center italic">
        <span>* Explanation of the chart axes or data.</span>
      </div> -->
    </div>

    <!-- Defect Insights Panel -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 z-0">
      <!-- Insights & Recommendations for Defects -->
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-5 shadow-2xl z-0">
        <div class="flex items-center mb-4">
          <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-red-400 to-pink-600 flex items-center justify-center shadow-md text-white"> <!-- Changed color -->
            <i class="ri-lightbulb-flash-line text-xl"></i>
          </div>
          <h3 class="ml-3 text-base font-semibold text-white">Defect Insights</h3>
        </div>
        
        <ul class="space-y-3">
          <li class="flex items-start">
            <div class="mt-0.5 flex-shrink-0 w-5 h-5 rounded-full bg-red-900/50 flex items-center justify-center">
              <i class="ri-arrow-up-line text-red-400 text-sm"></i>
            </div>
            <span class="ml-2 text-sm text-gray-300">Highest number of defects opened on <strong class="text-red-400">{{PEAK_DEFECT_DATE}}</strong> ({{PEAK_DEFECT_COUNT}} defects).</span>
          </li>
          <li class="flex items-start">
            <div class="mt-0.5 flex-shrink-0 w-5 h-5 rounded-full bg-green-900/50 flex items-center justify-center">
              <i class="ri-check-double-line text-green-400 text-sm"></i>
            </div>
            <span class="ml-2 text-sm text-gray-300">{{TOTAL_DEFECTS_CLOSED_PERCENT}}% of defects have been closed.</span>
          </li>
          <li class="flex items-start">
            <div class="mt-0.5 flex-shrink-0 w-5 h-5 rounded-full bg-amber-900/50 flex items-center justify-center">
              <i class="ri-time-line text-amber-400 text-sm"></i>
            </div>
            <span class="ml-2 text-sm text-gray-300">Average time to close <strong class="text-amber-400">{{SEVERITY_FOR_AVG_TIME}}</strong> defects is {{AVG_FIX_TIME_FOR_SEVERITY}} days.</span>
          </li>
          <li class="flex items-start">
            <div class="mt-0.5 flex-shrink-0 w-5 h-5 rounded-full bg-purple-900/50 flex items-center justify-center">
              <i class="ri-focus-3-fill text-purple-400 text-sm"></i>
            </div>
            <span class="ml-2 text-sm text-gray-300">Module <strong class="text-purple-400">{{MODULE_WITH_MOST_OPEN_DEFECTS}}</strong> currently has the most open defects ({{MOST_OPEN_DEFECTS_COUNT}}).</span>
          </li>
        </ul>
      </div>
      
      <!-- Defect Metrics -->
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-5 shadow-2xl z-0">
        <div class="flex items-center mb-4">
          <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-400 to-red-600 flex items-center justify-center shadow-md text-white"> <!-- Changed color -->
            <i class="ri-calculator-line text-xl"></i>
          </div>
          <h3 class="ml-3 text-base font-semibold text-white">Defect Metrics</h3>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-800/50 rounded-xl p-4">
            <p class="text-xs text-gray-400 mb-2">Open Defect Ratio</p>
            <div class="flex items-baseline">
              <span class="text-2xl font-bold text-white">{{OPEN_DEFECT_RATIO}}%</span>
              <span class="ml-1 text-sm text-gray-400">of total</span>
            </div>
            <div class="flex items-center mt-2 text-xs">
              <div class="flex-1 bg-gray-700 h-1.5 rounded-full overflow-hidden">
                <div class="bg-red-500 h-full rounded-full" style="width: {{OPEN_DEFECT_RATIO}}%"></div>
              </div>
              <span class="ml-2 text-gray-400">{{OPEN_DEFECT_RATIO}}%</span>
            </div>
          </div>
          
          <div class="bg-gray-800/50 rounded-xl p-4">
            <p class="text-xs text-gray-400 mb-2">Critical Open Defects</p>
            <div class="flex items-baseline">
              <span class="text-2xl font-bold text-white">{{CRITICAL_OPEN_COUNT}}</span>
              <span class="ml-1 text-sm text-gray-400">items</span>
            </div>
            <div class="flex items-center mt-2 text-xs">
              <div class="flex-1 bg-gray-700 h-1.5 rounded-full overflow-hidden">
                <div class="bg-pink-500 h-full rounded-full" style="width: {{CRITICAL_OPEN_RATIO}}%"></div>
              </div>
              <span class="ml-2 text-gray-400">{{CRITICAL_OPEN_RATIO}}%</span>
            </div>
          </div>
          
          <div class="bg-gray-800/50 rounded-xl p-4">
            <p class="text-xs text-gray-400 mb-2">Avg Age of Open</p>
            <div class="flex items-baseline">
              <span class="text-2xl font-bold text-white">{{AVG_OPEN_DEFECT_AGE}}</span>
              <span class="ml-1 text-sm text-gray-400">days</span>
            </div>
             <div class="flex items-center mt-2 text-xs">
              <div class="flex-1 bg-gray-700 h-1.5 rounded-full overflow-hidden">
                <div class="bg-amber-500 h-full rounded-full" style="width: {{AVG_OPEN_AGE_RATIO}}%"></div> <!-- Ratio calculation needed -->
              </div>
              <span class="ml-2 text-gray-400">{{AVG_OPEN_AGE_RATIO}}%</span>
            </div>
          </div>
          
          <div class="bg-gray-800/50 rounded-xl p-4">
            <p class="text-xs text-gray-400 mb-2">Defect Closure Rate</p>
             <div class="flex items-baseline">
               <span class="text-2xl font-bold text-white">{{DEFECT_CLOSURE_RATE}}</span>
               <span class="ml-1 text-sm text-gray-400">defects/day</span>
             </div>
             <div class="flex items-center mt-2 text-xs">
               <div class="flex-1 bg-gray-700 h-1.5 rounded-full overflow-hidden">
                 <div class="bg-green-500 h-full rounded-full" style="width: {{CLOSURE_RATE_RATIO}}%"></div> <!-- Ratio calculation needed -->
               </div>
               <span class="ml-2 text-gray-400">{{CLOSURE_RATE_RATIO}}%</span>
             </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-6 flex flex-wrap justify-between items-center text-xs text-gray-400">
       <p class="flex items-center">
         <i class="ri-information-line mr-1"></i>
         <span>ข้อมูลอัพเดทอัตโนมัติทุกวันเวลา 00:00 น. (ICT)</span>
       </p>
       <p class="flex items-center mt-2 sm:mt-0">
         <i class="ri-time-line mr-1"></i>
         <span>อัพเดทล่าสุด: {{LAST_UPDATED}}</span>
       </p>
    </div>
  </div>
</div>

<!-- JavaScript for Defect Trend Chart -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ซ่อน loading หลังจากโหลดกราฟเสร็จ
    setTimeout(() => {
      const chartLoading = document.getElementById('defectChartLoading'); // Changed ID
      if (chartLoading) {
        chartLoading.classList.add('opacity-0');
        setTimeout(() => chartLoading.style.display = 'none', 500);
      }
    }, 1000); // Adjust timing if needed
    
    // Animation for numbers (kept the same)
    document.querySelectorAll('#defectTrendAnalysis .count-animation').forEach(element => { // Scope to this section
      const countTo = parseInt(element.getAttribute('data-count'));
      let count = 0;
      const interval = setInterval(() => {
        const increment = Math.ceil(countTo / 20);
        count = Math.min(count + increment, countTo);
        element.textContent = count.toFixed(countTo % 1 > 0 ? 1 : 0);
        if (count >= countTo) {
          clearInterval(interval);
        }
      }, 50);
    });
    
    // ตั้งค่า Progress Bar (kept the same, but ensure variables are passed)
    document.querySelectorAll('#defectTrendAnalysis .progress-bar').forEach(bar => { // Scope to this section
      const percentage = bar.getAttribute('data-percentage') || 0;
      setTimeout(() => {
        bar.style.width = percentage + '%';
      }, 300);
    });
    
    // ตั้งค่าปุ่มเลือกช่วงเวลา (adjust grouping logic)
    document.querySelectorAll('#defectTrendAnalysis .period-btn').forEach(btn => { // Scope to this section
      btn.addEventListener('click', function() {
        document.querySelectorAll('#defectTrendAnalysis .period-btn').forEach(b => {
          b.classList.remove('bg-gradient-to-r', 'from-red-600', 'to-pink-600', 'text-white', 'shadow-lg');
          b.classList.add('bg-gray-800', 'text-gray-300', 'hover:bg-gray-700');
        });
        this.classList.remove('bg-gray-800', 'text-gray-300', 'hover:bg-gray-700');
        this.classList.add('bg-gradient-to-r', 'from-red-600', 'to-pink-600', 'text-white', 'shadow-lg');
        
        const grouping = this.getAttribute('data-grouping');
        updateDefectChart(grouping); // Call defect chart update function
      });
    });
    
    // ตั้งค่าปุ่มดาวน์โหลดกราฟ
    document.querySelector('.defect-trend-download-btn').addEventListener('click', function() { // Changed class selector
      const canvas = document.getElementById('defectTrendChart'); // Changed ID
      if (canvas) {
        const image = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = 'defect-trend-analysis.png'; // Changed filename
        link.href = image;
        link.click();
      }
    });
    
    // Dropdown toggle functionality (kept the same)
    document.querySelectorAll('#defectTrendAnalysis .dropdown-toggle').forEach(button => { // Scope to this section
      button.addEventListener('click', function() {
        const dropdownMenu = this.nextElementSibling;
        if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
          const isHidden = dropdownMenu.classList.contains('hidden');
          // Close other dropdowns first
          document.querySelectorAll('#defectTrendAnalysis .dropdown-menu').forEach(menu => {
            if (menu !== dropdownMenu) {
                menu.classList.add('hidden');
            }
          });
          // Toggle the current one
          dropdownMenu.classList.toggle('hidden', !isHidden);
        }
      });
    });
    
    // Close dropdowns when clicking outside (kept the same)
    document.addEventListener('click', function(event) {
      if (!event.target.closest('#defectTrendAnalysis .dropdown')) { // Scope to this section
        document.querySelectorAll('#defectTrendAnalysis .dropdown-menu').forEach(menu => {
          menu.classList.add('hidden');
        });
      }
    });
    
    // Add shimmer animation (kept the same)
    if (!document.querySelector('#shimmer-animation')) {
      const style = document.createElement('style');
      style.id = 'shimmer-animation';
      style.textContent = \`
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .animate-shimmer { animation: shimmer 2s infinite; }
      \`;
      document.head.appendChild(style);
    }
    
    // สร้างกราฟ Defect Trend ด้วย Chart.js
    const createDefectTrendChart = () => {
      const ctx = document.getElementById('defectTrendChart').getContext('2d'); // Changed ID
      
      // สร้าง gradient สำหรับพื้นหลังกราฟเส้น
      const redGradient = ctx.createLinearGradient(0, 0, 0, 400);
      redGradient.addColorStop(0, 'rgba(244, 63, 94, 0.2)');
      redGradient.addColorStop(1, 'rgba(244, 63, 94, 0.0)');
      
      const greenGradient = ctx.createLinearGradient(0, 0, 0, 400);
      greenGradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
      greenGradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');
      
      // ค่าที่ควรจะได้รับจาก template (เปลี่ยนชื่อตัวแปร)
      let defectTrendLabels = {{DEFECT_TREND_LABELS|default('[]')|safe}};
      let defectTrendOpened = {{DEFECT_TREND_OPENED|default('[]')|safe}};
      let defectTrendClosed = {{DEFECT_TREND_CLOSED|default('[]')|safe}};
      
      // สร้างข้อมูลตัวอย่างหากไม่มีข้อมูลจริง
      if (!defectTrendLabels || defectTrendLabels.length === 0) {
        defectTrendLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7'];
        defectTrendOpened = [12, 19, 13, 15, 14, 16, 14];
        defectTrendClosed = [8, 12, 10, 12, 14, 13, 15];
      }
      
      // สร้างกราฟด้วย Chart.js
      const defectTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: defectTrendLabels,
          datasets: [
            {
              label: 'Defects Opened',
              data: defectTrendOpened,
              borderColor: 'rgb(244, 63, 94)', // Red
              backgroundColor: redGradient,
              borderWidth: 2,
              pointBackgroundColor: 'rgb(255, 255, 255)',
              pointBorderColor: 'rgb(244, 63, 94)',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
              yAxisID: 'y', // Use the primary y-axis
              tension: 0.3,
              fill: true,
              order: 1 // Draw opened defects first
            },
            {
              label: 'Defects Closed',
              data: defectTrendClosed,
              borderColor: 'rgb(16, 185, 129)', // Green
              backgroundColor: greenGradient,
              borderWidth: 2,
              pointBackgroundColor: 'rgb(255, 255, 255)',
              pointBorderColor: 'rgb(16, 185, 129)',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
              yAxisID: 'y', // Use the primary y-axis
              tension: 0.3,
              fill: true,
              order: 2 // Draw closed defects after opened
            }
            // Remove Test Cases and Coverage datasets
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          hover: {
            mode: 'nearest',
            intersect: true
          },
          animations: {
             tension: { duration: 1000, easing: 'linear', from: 0.4, to: 0.3, loop: false }
          },
          scales: {
            y: { // Primary Y-axis for counts
              beginAtZero: true,
              position: 'left',
              grid: { drawBorder: false, color: 'rgba(75, 85, 99, 0.2)' },
              ticks: { font: { size: 11 }, padding: 8, color: 'rgba(156, 163, 175, 0.8)' }
            },
            // Remove y1 axis (for percentage) if not needed
            x: {
              grid: { drawBorder: false, display: false },
              ticks: { font: { size: 11 }, padding: 5, color: 'rgba(156, 163, 175, 0.8)', maxRotation: 30, minRotation: 0 }
            }
          },
          plugins: {
            legend: { display: false }, // Use custom legend below chart
            tooltip: {
              backgroundColor: 'rgba(17, 24, 39, 0.8)',
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              padding: 12,
              cornerRadius: 8,
              bodySpacing: 6,
              usePointStyle: true,
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              boxPadding: 4,
              callbacks: {
                labelPointStyle: function(context) { return { pointStyle: 'circle', rotation: 0 }; },
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) { label += ': '; }
                  label += context.parsed.y; // Show count
                  return label;
                }
              }
            }
          }
        }
      });
      
      return defectTrendChart;
    };
    
    // สร้างกราฟเริ่มต้น
    let defectChart = createDefectTrendChart(); // Use a different variable name
    
    // ฟังก์ชันอัพเดทกราฟเมื่อเปลี่ยนช่วงเวลา
    function updateDefectChart(grouping) { // Changed parameter name
      const chartLoading = document.getElementById('defectChartLoading'); // Changed ID
      if (chartLoading) {
        chartLoading.style.display = 'flex';
        chartLoading.classList.remove('opacity-0');
      }
      
      // Simulate fetching data based on grouping (daily, weekly, monthly)
      // **IMPORTANT**: This requires backend/Python changes to process data accordingly
      console.log("Updating defect chart with grouping:", grouping); 
      
      // Placeholder: Update date range text
      const dateRange = document.querySelector('.defect-trend-date-range');
      if (dateRange) {
         dateRange.textContent = 'Showing data grouped ' + grouping;
      }

      // Simulate loading delay
      setTimeout(() => {
        // **IMPORTANT**: In a real application, you would:
        // 1. Fetch new data from the backend based on the selected grouping.
        // 2. Update the chart's data:
        //    defectChart.data.labels = newLabels;
        //    defectChart.data.datasets[0].data = newOpenedData;
        //    defectChart.data.datasets[1].data = newClosedData;
        //    defectChart.update();

        // Hide loading indicator
        if (chartLoading) {
          chartLoading.classList.add('opacity-0');
          setTimeout(() => chartLoading.style.display = 'none', 500);
        }
      }, 1000);
    }

    // Tooltip initialization for buttons
    document.querySelectorAll('#defectTrendAnalysis .tooltip-trigger').forEach(trigger => {
       const tooltip = trigger.querySelector('.tooltip-content');
       if (tooltip) {
         trigger.addEventListener('mouseenter', () => tooltip.classList.remove('hidden'));
         trigger.addEventListener('mouseleave', () => tooltip.classList.add('hidden'));
       }
    });

  });
</script>
<!-- End: Advanced Defect Trend Analysis -->

<!-- Add custom animation and style -->
<style>
  /* Keep existing animations: float, float-delayed, float-slow, shimmer, progress, grow, drawPath */
  @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
  @keyframes float-delayed { 0% { transform: translateY(0px); } 50% { transform: translateY(-3px); } 100% { transform: translateY(0px); } }
  @keyframes float-slow { 0% { transform: translateY(0px); } 50% { transform: translateY(-2px); } 100% { transform: translateY(0px); } }
  .animate-float { animation: float 4s ease-in-out infinite; }
  .animate-float-delayed { animation: float-delayed 3s ease-in-out infinite; animation-delay: 1s; }
  .animate-float-slow { animation: float-slow 5s ease-in-out infinite; animation-delay: 0.5s; }
  .circle-animation { animation: progress 1.5s ease-out forwards; }
  .bar-animation { animation: grow 1.5s ease-out forwards; }
  .trend-path { animation: drawPath 2s ease-out forwards; }
  @keyframes progress { from { stroke-dashoffset: 100; } to { stroke-dashoffset: 25; } } /* Adjust 'to' value based on desired progress */
  @keyframes grow { from { width: 0%; } to { width: var(--target-width, 100%); } }
  @keyframes drawPath { to { stroke-dashoffset: 0; } }
  
  /* Neon Text Styles */
  .neon-text-gray { text-shadow: 0 0 8px rgba(156, 163, 175, 0.4); }
  .neon-text-red { text-shadow: 0 0 8px rgba(244, 63, 94, 0.4); }
  .neon-text-green { text-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }
  .neon-text-amber { text-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }

  /* Pattern grid background */
  .bg-pattern-grid {
    background-image: radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
  }
  
  /* Ensure chart canvas doesn't overflow */
  #defectTrendChart {
     max-width: 100%;
  }
</style> 